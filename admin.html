<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>WQT â€” Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #020617;
      --card-bg: #0f172a;
      --border: #1e293b;
      --text-main: #f1f5f9;
      --text-soft: #94a3b8;
      --accent: #38bdf8;
      --success: #22c55e;
      --danger: #ef4444;
    }
    body { font-family: system-ui, sans-serif; background: var(--bg); color: var(--text-main); padding: 2rem; min-height: 100vh; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
    .card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem; }
    .live-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; }
    .user-card { background: #1e293b; border: 1px solid var(--border); border-radius: 8px; padding: 1rem; position: relative; overflow: hidden; }
    .user-card.active { border-left: 4px solid var(--success); }
    .user-card.idle { border-left: 4px solid var(--text-soft); }
    .user-card.offline { border-left: 4px solid var(--danger); opacity: 0.7; }
    .user-head { display: flex; justify-content: space-between; margin-bottom: 0.5rem; }
    .user-name { font-weight: bold; font-size: 1.1rem; }
    .pill { padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 600; }
    .pill-green { background: rgba(34, 197, 94, 0.2); color: var(--success); }
    .pill-blue { background: rgba(56, 189, 248, 0.2); color: var(--accent); }
    table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
    td, th { padding: 8px; border-bottom: 1px solid var(--border); text-align: left; color: var(--text-soft); }
    .refresh-btn { background: var(--accent); color: #000; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 600; cursor: pointer; }
    .error-banner { background: rgba(239, 68, 68, 0.2); border: 1px solid var(--danger); color: #fca5a5; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; display: none; }
  </style>
</head>
<body>

  <header style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
    <h1>WQT Admin Dashboard</h1>
    <button class="refresh-btn" onclick="loadData()">Refresh Data</button>
  </header>

  <div id="error-box" class="error-banner"></div>

  <section class="card" style="margin-bottom: 2rem;">
    <div class="card-header">
      <div style="font-weight:600; color:var(--text-soft);">LIVE FLOOR ACTIVITY</div>
      <div id="active-count">0 Active</div>
    </div>
    <div id="live-floor" class="live-grid">Loading...</div>
  </section>

  <section class="card">
    <div class="card-header"><div style="font-weight:600; color:var(--text-soft);">RECENT EVENTS</div></div>
    <table id="events-table">
      <thead><tr><th>Time</th><th>User</th><th>Action</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <script>
    const API_BASE = "https://wqt-backend.onrender.com";

    async function fetchJSON(endpoint) {
      const errBox = document.getElementById("error-box");
      try {
        const res = await fetch(`${API_BASE}${endpoint}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        errBox.style.display = 'none';
        return await res.json();
      } catch (e) {
        errBox.textContent = `Connection Failed: ${e.message}`;
        errBox.style.display = 'block';
        return [];
      }
    }

    async function loadData() {
      const events = await fetchJSON("/api/usage/recent?limit=50");
      if (events.length === 0) {
         document.getElementById("live-floor").innerHTML = '<div style="padding:1rem">No recent data.</div>';
         return;
      }
      render(events);
    }

    function render(events) {
      const devices = {};
      
      // 1. Calculate Reference Time (Sync with Server)
      // Find the absolute latest timestamp in the list. Assume that is "Now".
      const timestamps = events.map(e => new Date(e.created_at).getTime());
      const serverNow = Math.max(...timestamps, Date.now()); 

      // Process oldest to newest
      [...events].reverse().forEach(ev => {
        if (!ev.detail) return;
        
        let name = "Anonymous";
        if (ev.detail.current && ev.detail.current.name) name = ev.detail.current.name;
        const devId = ev.device_id || `User-${name}`; // Fallback if backend ID missing

        if (ev.category === "STATE_SAVE") {
          devices[devId] = {
            id: devId,
            name: name,
            lastSeen: new Date(ev.created_at).getTime(),
            current: ev.detail.current,
            picks: ev.detail.picks || []
          };
        }
      });

      // Render Cards
      const container = document.getElementById("live-floor");
      container.innerHTML = "";
      
      const activeList = Object.values(devices)
        .sort((a,b) => b.lastSeen - a.lastSeen)
        .filter(d => (serverNow - d.lastSeen) < 86400000); // 24h filter

      document.getElementById("active-count").textContent = `${activeList.length} Active (24h)`;

      activeList.forEach(d => {
        const minsAgo = Math.floor((serverNow - d.lastSeen) / 60000);
        const isIdle = !d.current;
        
        let status = "Picking";
        let colorClass = "active";

        if (isIdle) { status = "Idle"; colorClass = "idle"; }
        // Relaxed offline threshold: 20 mins
        if (minsAgo > 20) { status = "Offline"; colorClass = "offline"; }

        const total = (d.picks || []).reduce((a,b) => a + (b.units||0), 0);
        let detailText = isIdle ? "No active order" : `${d.current.name} (${d.current.orderRateUh||0} u/h)`;

        container.innerHTML += `
          <div class="user-card ${colorClass}">
            <div class="user-head">
              <span class="user-name">${d.name === "Anonymous" ? d.id.substring(0,8) : d.name}</span>
              <span class="pill ${status==='Picking'?'pill-green':'pill-blue'}">${status}</span>
            </div>
            <div class="user-meta" style="font-size:0.9rem; color:#94a3b8; margin-top:8px;">
              <div>${detailText}</div>
              <div style="border-top:1px solid #334155; margin-top:6px; padding-top:6px;">
                 Total Today: <b style="color:#f1f5f9">${total}</b>
              </div>
              <div style="font-size:0.75rem; margin-top:4px;">Sync: ${minsAgo}m ago</div>
            </div>
          </div>`;
      });

      // Render Table
      const tbody = document.querySelector("#events-table tbody");
      tbody.innerHTML = "";
      events.slice(0, 15).forEach(ev => {
        const time = new Date(ev.created_at).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        const name = (ev.detail && ev.detail.current) ? ev.detail.current.name : "???";
        const action = (ev.detail && ev.detail.current) ? "Picking" : "Idle";
        tbody.innerHTML += `<tr><td>${time}</td><td>${name}</td><td>${action}</td></tr>`;
      });
    }

    loadData();
    setInterval(loadData, 30000);
  </script>
</body>
</html>