<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>WQT â€” Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #020617;
      --card-bg: #0f172a;
      --border: #1e293b;
      --text-main: #f1f5f9;
      --text-soft: #94a3b8;
      --accent: #38bdf8;
      --success: #22c55e;
      --danger: #ef4444;
      --warn: #f59e0b;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text-main);
      padding: 2rem;
      min-height: 100vh;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    .card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border);
    }
    .card-title {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-soft);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    /* Live Floor Table */
    .live-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1rem;
    }
    .user-card {
      background: #1e293b;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      position: relative;
      overflow: hidden;
    }
    .user-card.active { border-left: 4px solid var(--success); }
    .user-card.idle { border-left: 4px solid var(--text-soft); }
    .user-head { display: flex; justify-content: space-between; margin-bottom: 0.5rem; }
    .user-name { font-weight: 700; font-size: 1.1rem; }
    .user-status { font-size: 0.75rem; padding: 2px 8px; border-radius: 99px; background: #334155; }
    .user-card.active .user-status { background: rgba(34, 197, 94, 0.2); color: var(--success); }
    .user-meta { font-size: 0.85rem; color: var(--text-soft); display: flex; flex-direction: column; gap: 4px; }
    .stat-row { display: flex; justify-content: space-between; }
    /* Tables */
    table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
    th { text-align: left; color: var(--text-soft); padding: 8px; border-bottom: 1px solid var(--border); font-weight: 600; }
    td { padding: 8px; border-bottom: 1px solid var(--border); color: var(--text-main); }
    .pill { padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 600; }
    .pill-green { background: rgba(34, 197, 94, 0.15); color: var(--success); border: 1px solid rgba(34, 197, 94, 0.3); }
    .pill-blue { background: rgba(56, 189, 248, 0.15); color: var(--accent); border: 1px solid rgba(56, 189, 248, 0.3); }
    .pill-gray { background: #334155; color: var(--text-soft); }
    
    .refresh-btn {
      background: var(--accent);
      color: #000;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
    }
    .error-banner {
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid var(--danger);
      color: #fca5a5;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1.5rem;
      display: none;
    }
  </style>
</head>
<body>

  <header style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
    <div>
      <h1 style="font-size:1.5rem;">WQT Admin Dashboard</h1>
      <p style="color:var(--text-soft); font-size:0.9rem;">Live view of warehouse floor activity</p>
    </div>
    <button class="refresh-btn" onclick="loadData()">Refresh Data</button>
  </header>

  <div id="error-box" class="error-banner"></div>

  <section class="card" style="margin-bottom: 2rem;">
    <div class="card-header">
      <div class="card-title">Live Floor Activity</div>
      <div class="card-title" id="active-count">0 Active</div>
    </div>
    <div id="live-floor" class="live-grid">
      <div style="color:var(--text-soft); padding:1rem;">Loading live state...</div>
    </div>
  </section>

  <div class="grid">
    <section class="card">
      <div class="card-header">
        <div class="card-title">Recent System Events</div>
      </div>
      <div style="overflow-x: auto;">
        <table id="events-table">
          <thead>
            <tr>
              <th>Time</th>
              <th>Device</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="3" style="text-align:center; padding:1rem;">Loading events...</td></tr>
          </tbody>
        </table>
      </div>
    </section>
  </div>

  <script>
    // --- CONFIG ---
    // Forces connection to live Render DB for both Local (file://) and Mobile usage.
    const API_BASE = "https://wqt-backend.onrender.com";

    async function fetchJSON(endpoint) {
      const errBox = document.getElementById("error-box");
      try {
        const res = await fetch(`${API_BASE}${endpoint}`);
        if (!res.ok) throw new Error(`HTTP Error ${res.status}`);
        errBox.style.display = 'none'; // Hide error if success
        return await res.json();
      } catch (e) {
        console.error("Fetch failed:", e);
        // SHOW ERROR ON SCREEN
        errBox.textContent = `Connection Failed: ${e.message}. Is the backend URL correct?`;
        errBox.style.display = 'block';
        return [];
      }
    }

    // --- LOGIC ---

    async function loadData() {
      // 1. Load Recent Events
      const events = await fetchJSON("/api/usage/recent?limit=50");
      
      // If empty and no error displayed, show empty state
      if (events.length === 0 && document.getElementById("error-box").style.display === 'none') {
         document.getElementById("live-floor").innerHTML = '<div style="padding:1rem">No recent data found in database.</div>';
         document.querySelector("#events-table tbody").innerHTML = '<tr><td colspan="3" style="padding:1rem">No events returned.</td></tr>';
         return;
      }
      
      renderEventsTable(events);
      const deviceState = processLiveState(events);
      renderLiveFloor(deviceState);
    }

    function processLiveState(events) {
      const devices = {};
      const chronology = [...events].reverse();

      chronology.forEach(ev => {
        if (!ev.detail) return;
        // Fallback for missing device_id
        const devId = ev.device_id || (ev.detail && ev.detail.current && ev.detail.current.name ? "User-" + ev.detail.current.name : "Unknown-Device");
        
        if (ev.category === "STATE_SAVE") {
          devices[devId] = {
            id: devId,
            lastSeen: new Date(ev.created_at), 
            current: ev.detail.current,
            picks: ev.detail.picks || []
          };
        }
      });
      return Object.values(devices).sort((a,b) => b.lastSeen - a.lastSeen);
    }

    function renderLiveFloor(devices) {
      const container = document.getElementById("live-floor");
      const countEl = document.getElementById("active-count");
      container.innerHTML = "";

      // 24 Hour Filter
      const now = new Date();
      const activeDevices = devices.filter(d => (now - d.lastSeen) < 86400000);

      countEl.textContent = `${activeDevices.length} Active (24h)`;

      if (activeDevices.length === 0) {
        container.innerHTML = `<div style="color:var(--text-soft)">No active devices found in the last 24h.</div>`;
        return;
      }

      activeDevices.forEach(d => {
        const isIdle = !d.current;
        const minsAgo = Math.floor((now - d.lastSeen) / 60000);
        const statusColor = minsAgo > 60 ? "offline" : (isIdle ? "idle" : "active");
        
        let statusText = isIdle ? "Idle" : "Picking";
        if (minsAgo > 60) statusText = "Offline";

        const totalUnits = (d.picks || []).reduce((sum, p) => sum + (p.units || 0), 0);

        let orderInfo = `<span style="color:var(--text-soft)">No active order</span>`;
        if (d.current) {
            orderInfo = `
                <div class="stat-row">
                    <span>${d.current.name}</span>
                    <span style="color:var(--accent)">${d.current.orderRateUh || 0} u/h</span>
                </div>`;
        }

        const card = document.createElement("div");
        card.className = `user-card ${statusColor === 'active' ? 'active' : 'idle'}`;
        card.innerHTML = `
          <div class="user-head">
            <span class="user-name">${d.id.substring(0, 12)}</span>
            <span class="user-status">${statusText}</span>
          </div>
          <div class="user-meta">
            ${orderInfo}
            <div class="stat-row" style="margin-top:8px; border-top:1px solid #334155; padding-top:4px;">
                <span>Total Today:</span>
                <span style="color:var(--text-main)">${totalUnits} units</span>
            </div>
            <div class="time-ago">Last sync: ${minsAgo}m ago</div>
          </div>
        `;
        container.appendChild(card);
      });
    }

    function renderEventsTable(events) {
      const tbody = document.querySelector("#events-table tbody");
      tbody.innerHTML = "";
      
      events.slice(0, 20).forEach(ev => {
        const tr = document.createElement("tr");
        const time = new Date(ev.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        let action = `<span class="pill pill-gray">System Check</span>`;
        let details = "";

        if (ev.category === "STATE_SAVE") {
            const d = ev.detail || {};
            if (d.current) {
                action = `<span class="pill pill-green">Picking</span>`;
                details = `${d.current.name} (${d.current.total}u)`;
            } else {
                action = `<span class="pill pill-blue">Idle</span>`;
                details = "No active order";
            }
        }

        tr.innerHTML = `
          <td><span style="color:var(--text-soft)">${time}</span></td>
          <td>${(ev.device_id || "???").substring(0,8)}</td>
          <td>${action} <span style="margin-left:8px; color:var(--text-soft); font-size:0.8em;">${details}</span></td>
        `;
        tbody.appendChild(tr);
      });
    }

    loadData();
    setInterval(loadData, 30000);
  </script>
</body>
</html>