<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>WQT â€” Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #020617;
      --card-bg: #0f172a;
      --border: #1e293b;
      --text-main: #f1f5f9;
      --text-soft: #94a3b8;
      --accent: #38bdf8;
      --success: #22c55e;
      --danger: #ef4444;
      --warn: #f59e0b;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text-main);
      padding: 2rem;
      min-height: 100vh;
    }
    h1, h2 { letter-spacing: -0.025em; }
    header { margin-bottom: 2rem; border-bottom: 1px solid var(--border); padding-bottom: 1rem; }
    
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border);
    }
    .card-title {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-soft);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    /* Live Floor Table */
    .live-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1rem;
    }
    .user-card {
      background: #1e293b;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      position: relative;
      overflow: hidden;
    }
    .user-card.active { border-left: 4px solid var(--success); }
    .user-card.idle { border-left: 4px solid var(--text-soft); }
    
    .user-head { display: flex; justify-content: space-between; margin-bottom: 0.5rem; }
    .user-name { font-weight: 700; font-size: 1.1rem; }
    .user-status { font-size: 0.75rem; padding: 2px 8px; border-radius: 99px; background: #334155; }
    .user-card.active .user-status { background: rgba(34, 197, 94, 0.2); color: var(--success); }
    
    .user-meta { font-size: 0.85rem; color: var(--text-soft); display: flex; flex-direction: column; gap: 4px; }
    .stat-row { display: flex; justify-content: space-between; }
    
    /* Tables */
    table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
    th { text-align: left; color: var(--text-soft); padding: 8px; border-bottom: 1px solid var(--border); font-weight: 600; }
    td { padding: 8px; border-bottom: 1px solid var(--border); color: var(--text-main); }
    tr:last-child td { border-bottom: none; }
    
    .time-ago { color: var(--text-soft); font-size: 0.75rem; }
    
    /* Status Pills */
    .pill { padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 600; }
    .pill-green { background: rgba(34, 197, 94, 0.15); color: var(--success); border: 1px solid rgba(34, 197, 94, 0.3); }
    .pill-blue { background: rgba(56, 189, 248, 0.15); color: var(--accent); border: 1px solid rgba(56, 189, 248, 0.3); }
    .pill-gray { background: #334155; color: var(--text-soft); }

    .refresh-btn {
      background: var(--accent);
      color: #000;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    .refresh-btn:hover { opacity: 0.9; }

  </style>
</head>
<body>

  <header style="display:flex; justify-content:space-between; align-items:center;">
    <div>
      <h1>WQT Admin Dashboard</h1>
      <p style="color:var(--text-soft); font-size:0.9rem;">Live view of warehouse floor activity</p>
    </div>
    <button class="refresh-btn" onclick="loadData()">Refresh Data</button>
  </header>

  <section class="card" style="margin-bottom: 2rem;">
    <div class="card-header">
      <div class="card-title">Live Floor Activity</div>
      <div class="card-title" id="active-count">0 Active</div>
    </div>
    <div id="live-floor" class="live-grid">
      <div style="color:var(--text-soft); padding:1rem;">Loading live state...</div>
    </div>
  </section>

  <div class="grid">
    <section class="card">
      <div class="card-header">
        <div class="card-title">Units Picked (Last 7 Days)</div>
      </div>
      <div id="stats-chart" style="height: 200px; display:flex; align-items:flex-end; gap:8px;">
        </div>
    </section>

    <section class="card">
      <div class="card-header">
        <div class="card-title">Recent System Events</div>
      </div>
      <div style="overflow-x: auto;">
        <table id="events-table">
          <thead>
            <tr>
              <th>Time</th>
              <th>Device</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="3" style="text-align:center; padding:1rem;">Loading events...</td></tr>
          </tbody>
        </table>
      </div>
    </section>
  </div>

  <script>
    // --- CONFIG ---
    // If running locally, this ensures we talk to Render.
    // If running on Render, it talks to self.
    const API_BASE = window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1"
        ? "https://wqt-backend.onrender.com"
        : "";

    async function fetchJSON(endpoint) {
      try {
        const res = await fetch(`${API_BASE}${endpoint}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return await res.json();
      } catch (e) {
        console.error("Fetch failed:", e);
        return [];
      }
    }

    // --- LOGIC ---

    async function loadData() {
      // 1. Load Recent Events (raw log)
      const events = await fetchJSON("/api/usage/recent?limit=50");
      renderEventsTable(events);

      // 2. Process "Live Floor" state from the events
      const deviceState = processLiveState(events);
      renderLiveFloor(deviceState);

      // 3. Calculate daily stats from the events (approximate)
      renderDailyStats(events);
    }

    // Turn raw event log into a map of "Last Known State" per device
    function processLiveState(events) {
      const devices = {}; // { deviceId: { lastSeen, currentOrder, shiftStart, ... } }

      // Process oldest to newest to build state
      // (The API returns newest first, so we reverse for state rebuilding)
      const chronology = [...events].reverse();

      chronology.forEach(ev => {
        if (!ev.detail) return;
        const d = ev.detail; // The full state blob
        const devId = ev.device_id || "unknown";

        // If this is a state save, update the device's snapshot
        if (ev.category === "STATE_SAVE") {
          devices[devId] = {
            id: devId,
            lastSeen: new Date(ev.created_at),
            current: d.current,          // Active order object
            startTime: d.startTime,      // Shift start HH:MM
            picks: d.picks || [],        // Completed orders today
            pickerName: (d.current && d.current.name) ? "Picking " + d.current.name : "Idle"
          };
        }
      });
      return Object.values(devices).sort((a,b) => b.lastSeen - a.lastSeen);
    }

    function renderLiveFloor(devices) {
      const container = document.getElementById("live-floor");
      const countEl = document.getElementById("active-count");
      container.innerHTML = "";

      // Filter out devices not seen in 24h
      const now = new Date();
      const activeDevices = devices.filter(d => (now - d.lastSeen) < 86400000);

      countEl.textContent = `${activeDevices.length} Active (24h)`;

      if (activeDevices.length === 0) {
        container.innerHTML = `<div style="color:var(--text-soft)">No active devices found.</div>`;
        return;
      }

      activeDevices.forEach(d => {
        const isIdle = !d.current;
        const minsAgo = Math.floor((now - d.lastSeen) / 60000);
        const statusColor = minsAgo > 15 ? "offline" : (isIdle ? "idle" : "active");
        
        // Calculate units done today
        const totalUnits = (d.picks || []).reduce((sum, p) => sum + (p.units || 0), 0);
        
        const card = document.createElement("div");
        card.className = `user-card ${statusColor === 'active' ? 'active' : 'idle'}`;
        
        let statusText = isIdle ? "Idle" : "Picking";
        if (minsAgo > 60) statusText = "Offline";

        // Current order details
        let orderInfo = `<span style="color:var(--text-soft)">No active order</span>`;
        if (d.current) {
            orderInfo = `
                <div class="stat-row">
                    <span>${d.current.name}</span>
                    <span style="color:var(--accent)">${d.current.orderRateUh || 0} u/h</span>
                </div>
            `;
        }

        card.innerHTML = `
          <div class="user-head">
            <span class="user-name">${d.id.substring(0, 6)}...</span>
            <span class="user-status">${statusText}</span>
          </div>
          <div class="user-meta">
            ${orderInfo}
            <div class="stat-row" style="margin-top:8px; border-top:1px solid #334155; padding-top:4px;">
                <span>Total Today:</span>
                <span style="color:var(--text-main)">${totalUnits} units</span>
            </div>
            <div class="time-ago">Last sync: ${minsAgo}m ago</div>
          </div>
        `;
        container.appendChild(card);
      });
    }

    function renderEventsTable(events) {
      const tbody = document.querySelector("#events-table tbody");
      tbody.innerHTML = "";
      
      events.slice(0, 20).forEach(ev => {
        const tr = document.createElement("tr");
        const time = new Date(ev.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        // Humanize the action
        let action = `<span class="pill pill-gray">System Check</span>`;
        let details = "";

        if (ev.category === "STATE_SAVE") {
            const d = ev.detail || {};
            if (d.current) {
                action = `<span class="pill pill-green">Picking</span>`;
                details = `${d.current.name} (${d.current.total}u)`;
            } else {
                action = `<span class="pill pill-blue">Idle / Menu</span>`;
                details = "No active order";
            }
        }

        tr.innerHTML = `
          <td><span style="color:var(--text-soft)">${time}</span></td>
          <td>${(ev.device_id || "???").substring(0,8)}</td>
          <td>${action} <span style="margin-left:8px; color:var(--text-soft); font-size:0.8em;">${details}</span></td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Mock chart renderer (replace with Chart.js later if you want fancy graphs)
    function renderDailyStats(events) {
       const chart = document.getElementById("stats-chart");
       chart.innerHTML = "";
       // This is a placeholder. Real stats require a backend aggregation endpoint 
       // like /api/stats/daily which we can build next.
       chart.innerHTML = `<div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; color:var(--text-soft); border:1px dashed var(--border); border-radius:8px;">
          Daily Stats Aggregation Coming Soon
       </div>`;
    }

    // Auto-load
    loadData();
    // Auto-refresh every 30s
    setInterval(loadData, 30000);

  </script>
</body>
</html>