<div id="deviceModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:9999; align-items:center; justify-content:center;">
  <div class="card" style="width:min(500px, 90%); position:relative;">
    <button onclick="closeModal()" style="position:absolute; top:15px; right:15px; background:transparent; border:none; color:#fff; font-size:1.5rem; cursor:pointer;">&times;</button>
    <h2 id="modalTitle" style="margin-top:0;">User Details</h2>
    <div id="modalContent" style="margin-top:20px;"></div>
  </div>
</div>

<script>
    const API_BASE = "https://wqt-backend.onrender.com";
    let allDevicesData = []; // Store data globally for the modal

    async function fetchJSON(endpoint) {
      const errBox = document.getElementById("error-box");
      try {
        const res = await fetch(`${API_BASE}${endpoint}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        errBox.style.display = 'none';
        return await res.json();
      } catch (e) {
        errBox.textContent = `Connection Failed: ${e.message}`;
        errBox.style.display = 'block';
        return [];
      }
    }

    async function refreshAll() {
        await Promise.all([loadLiveFloor(), loadRecentLogs()]);
    }

    // ---------------------------------------------------------
    // 1. LIVE FLOOR LOGIC
    // ---------------------------------------------------------
    async function loadLiveFloor() {
      const devices = await fetchJSON("/api/admin/devices");
      allDevicesData = devices; // Save for modal usage
      const container = document.getElementById("live-floor");
      
      if (!devices || devices.length === 0) {
          container.innerHTML = '<div style="padding:1rem">No devices found in DB.</div>';
          document.getElementById("active-count").textContent = "0 Devices";
          return;
      }

      container.innerHTML = "";
      document.getElementById("active-count").textContent = `${devices.length} Devices Found`;

      devices.sort((a, b) => new Date(b.savedAt || 0).getTime() - new Date(a.savedAt || 0).getTime());
      const now = Date.now();

      devices.forEach((d, index) => {
        const devId = d.device_id || "Unknown ID";
        const savedAt = d.savedAt ? new Date(d.savedAt).getTime() : 0;
        const current = d.current || {};
        
        // --- PRIORITY FIX: Always look for operator_id first ---
        const opName = current.operator_id || "Unassigned";

        const minsAgo = Math.floor((now - savedAt) / 60000);
        let status = "Active";
        let colorClass = "active";
        let badgeClass = "pill-green";

        if (minsAgo > 30) { 
            status = "Offline"; colorClass = "offline"; badgeClass = "pill-red";
        } else if (!current.name) {
            status = "Idle"; colorClass = "idle"; badgeClass = "pill-yellow";
        }

        // --- SIMPLIFIED CARD HTML ---
        // Click triggers openDeviceModal with the index of the data
        const html = `
          <div class="user-card ${colorClass}" onclick="openDeviceModal(${index})" style="cursor:pointer;">
            <div class="user-head">
              <div class="user-name">${opName}</div>
              <span class="pill ${badgeClass}">${status}</span>
            </div>
            <div style="font-size:0.8rem; color:#94a3b8;">
               ID: ${devId.substring(0,6)}... â€¢ ${minsAgo}m ago
            </div>
          </div>
        `;
        container.innerHTML += html;
      });
    }

    // ---------------------------------------------------------
    // 2. MODAL LOGIC (The detailed view)
    // ---------------------------------------------------------
    function openDeviceModal(index) {
        const d = allDevicesData[index];
        if (!d) return;

        const current = d.current || {};
        const picks = d.picks || [];
        const totalPicks = picks.reduce((sum, p) => sum + (p.units || 0), 0);
        const rate = current.liveRate || 0;
        const customer = current.name || "None";
        const startTime = d.startTime || "Not Started";
        const opId = current.operator_id || "Unknown User";

        document.getElementById('modalTitle').textContent = opId;
        
        document.getElementById('modalContent').innerHTML = `
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:20px;">
                <div style="background:#1e293b; padding:10px; border-radius:8px; text-align:center;">
                    <div style="font-size:0.8rem; color:#94a3b8;">Total Units</div>
                    <div style="font-size:1.5rem; font-weight:bold;">${totalPicks}</div>
                </div>
                <div style="background:#1e293b; padding:10px; border-radius:8px; text-align:center;">
                    <div style="font-size:0.8rem; color:#94a3b8;">Live Rate</div>
                    <div style="font-size:1.5rem; font-weight:bold; color:${rate >= 300 ? '#22c55e' : '#f59e0b'}">${rate}</div>
                </div>
            </div>
            
            <table style="width:100%; color:#cbd5e1;">
                <tr><td style="padding:8px; border-bottom:1px solid #334155;">Shift Start</td><td style="text-align:right;">${startTime}</td></tr>
                <tr><td style="padding:8px; border-bottom:1px solid #334155;">Current Customer</td><td style="text-align:right;">${customer}</td></tr>
                <tr><td style="padding:8px; border-bottom:1px solid #334155;">Device ID</td><td style="text-align:right;">${d.device_id || 'N/A'}</td></tr>
                <tr><td style="padding:8px;">Software Version</td><td style="text-align:right;">${d.version || 'v1.0'}</td></tr>
            </table>
        `;

        document.getElementById('deviceModal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('deviceModal').style.display = 'none';
    }

    // Close modal on outside click
    document.getElementById('deviceModal').addEventListener('click', function(e) {
        if (e.target === this) closeModal();
    });

    // ---------------------------------------------------------
    // 3. LOGS LOGIC (Unchanged)
    // ---------------------------------------------------------
    async function loadRecentLogs() {
        const events = await fetchJSON("/api/usage/recent?limit=20");
        const tbody = document.querySelector("#events-table tbody");
        tbody.innerHTML = "";
        if (events.length === 0) { tbody.innerHTML = '<tr><td colspan="3">No events recorded.</td></tr>'; return; }
        events.forEach(ev => {
            const time = new Date(ev.created_at).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'});
            let detailStr = "";
            if (ev.detail) {
                if (ev.detail.current_name) detailStr += `User: <b>${ev.detail.current_name}</b> `;
                else if (ev.detail.operator_id) detailStr += `ID: ${ev.detail.operator_id} `;
                if (ev.detail.shift_id) detailStr += `(Shift #${ev.detail.shift_id})`;
            }
            tbody.innerHTML += `<tr><td>${time}</td><td><span class="pill pill-blue">${ev.category}</span></td><td>${detailStr}</td></tr>`;
        });
    }

    refreshAll();
    setInterval(refreshAll, 10000);
</script>